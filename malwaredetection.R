mydata<-read.csv("C:/Users/ULTRON/Music/Rmachine/MalwareSamples10000.csv")
df = subset(mydata, select = -c(specimenId) )
###To replace Nan value with 0
ind <- rowSums(is.na(df)) == ncol(df)
ind
set.seed(456)
########Process the data for machine learning algorithms
procdata <- data.frame(as.numeric(as.factor(df$hasExe)),
                       as.numeric(as.factor(df$hasZip)),
                       as.numeric(as.factor(df$hasPDF)),
                       as.numeric(as.factor(df$hasDoc)),
                       as.numeric(as.factor(df$hasUnknown)),
                       as.numeric(as.factor(df$hasURL)),
                       as.numeric(df$urlCount),
                       as.numeric(df$totalEmailSizeBytes),
                       as.numeric(as.factor(df$senderDomainSuffix)),
                       as.numeric(df$headerCount),
                       df$isMalware)
                       
colnames(procdata) <- c("hasExe", "hasZip", "hasPDF", "hasDoc", 
                        "hasUnknown", "hasURL","urlCount","totalEmailSizeBytes" ,"senderDomainSuffix","headerCount","isMalware")

procdata$isMalware <- ifelse(procdata$isMalware == "Yes", 1, 0)
procdata$isMalware <- factor(procdata$isMalware, levels = c(0, 1))
hist(as.numeric(procdata$isMalware),xlab = "Value",border = "blue")
########
####Train test split
fractionTraining   <- 0.80
fractionTest       <- 0.20

# Compute sample sizes.
sampleSizeTraining   <- floor(fractionTraining   * nrow(procdata))
sampleSizeTest       <- floor(fractionTest       * nrow(procdata))

# Create the randomly-sampled indices for the dataframe. Use setdiff() to
# avoid overlapping subsets of indices.
indicesTraining    <- sort(sample(seq_len(nrow(procdata)), size=sampleSizeTraining))
indicesTest        <- sample(seq_len(nrow(procdata)), size=sampleSizeTest)

# Finally, output the three dataframes for training, validation and test.
dfTraining   <- procdata[indicesTraining, ]
dfTest       <- procdata[indicesTest, ]
##To know the length of train and test dataset
nrow(dfTraining)
nrow(dfTest)
################
####Binary Logistic Regression
binfit <- glm(isMalware ~ hasExe + hasZip + hasPDF + hasDoc + hasUnknown + hasURL + urlCount + totalEmailSizeBytes + headerCount, data=dfTraining,family = binomial)
summary(binfit)
predictbin <- predict(binfit, newdata = dfTest)

#######
#######
library(caret)
y_pred_num <- ifelse(predictbin > 0.5, 1, 0)
y_pred <- factor(y_pred_num, levels=c(0, 1))
confusionMatrix(y_pred, dfTest$isMalware)
########## Recursive featureelimination (RFE)

library(mlbench)
library(Hmisc)
library(randomForest)
set.seed(10)

ctrl <- rfeControl(functions = lrFuncs,
                   method = "repeatedcv",
                   repeats = 5,
                   verbose = FALSE)
subsets <- c(1:5, 10, 15, 20, 25)
x=dfTraining[,0:10]
y=dfTraining$isMalware
lmProfile <- rfe(x, y,
                 sizes = subsets,
                 rfeControl = ctrl)

lmProfile
#############Logistic Elastic Regression 
library(ipred)
set.seed(123)
library(rpart) 
# train bagged model

ames_bag1 <- bagging(
  formula = isMalware ~ hasExe + hasZip + hasPDF + hasDoc + hasUnknown + hasURL + urlCount + totalEmailSizeBytes + headerCount,
  data = dfTraining,
  nbagg = 100,  
  coob = TRUE,
  control = rpart.control(minsplit = 2, cp = 0)
)
summary(ames_bag1)
bagpredict <- predict(ames_bag1, newdata = dfTest)
bagpredict
confusionMatrix(bagpredict, dfTest$isMalware)
#####Tuned Parameters with nbagg =100 

########LOgistic Elastic Net Regression
library(caret)
library(glmnet)
##Tuning the alpha as 1 and 0 for lasso 
set.seed(42)
cv_5 = trainControl(method = "cv", number = 5)
##Using 5 fold cross validation at first 
hit_elnet = train(
  isMalware ~ hasExe + hasZip + hasPDF + hasDoc + hasUnknown + hasURL + urlCount + totalEmailSizeBytes + headerCount, data = dfTraining,
  method = "glmnet",
  trControl = cv_5
)
summary(hit_elnet)
hit_elnet
##Using the alpha value as 0.1 
hit_elnet_int = train(
  isMalware ~ hasExe + hasZip + hasPDF + hasDoc + hasUnknown + hasURL + urlCount + totalEmailSizeBytes + headerCount, data = dfTraining,
  method = "glmnet",
  trControl = cv_5,
  tuneLength = 10
)
hit_elnet_int
logpredict<-predict(hit_elnet_int, newdata = dfTest)
confusionMatrix(logpredict, dfTest$isMalware)
###################################
#####Real world testing
#######################
testing<-read.csv("C:/Users/ULTRON/Music/Rmachine/EmailSamples50000(2).csv")
dat = subset(testing, select = -c(specimenId) )
###To replace Nan value with 0
ind <- rowSums(is.na(dat)) == ncol(dat)
ind
set.seed(456)
########Process the data for machine learning algorithms predictions
proctest <- data.frame(as.numeric(as.factor(dat$hasExe)),
                       as.numeric(as.factor(dat$hasZip)),
                       as.numeric(as.factor(dat$hasPDF)),
                       as.numeric(as.factor(dat$hasDoc)),
                       as.numeric(as.factor(dat$hasUnknown)),
                       as.numeric(as.factor(dat$hasURL)),
                       as.numeric(dat$urlCount),
                       as.numeric(dat$totalEmailSizeBytes),
                       as.numeric(as.factor(dat$senderDomainSuffix)),
                       as.numeric(dat$headerCount),
                       dat$isMalware)

colnames(proctest) <- c("hasExe", "hasZip", "hasPDF", "hasDoc", 
                        "hasUnknown", "hasURL","urlCount","totalEmailSizeBytes" ,"senderDomainSuffix","headerCount","isMalware")
proctest$isMalware <- ifelse(proctest$isMalware == "Yes", 1, 0)
proctest$isMalware <- factor(proctest$isMalware, levels = c(0, 1))
#########Binary Logistic predictions
testbin <- predict(binfit, newdata = proctest)

#######
#######
library(caret)
test_y_pred_num <- ifelse(testbin > 0.5, 1, 0)
test_y_pred <- factor(test_y_pred_num, levels=c(0, 1))
confusionMatrix(test_y_pred, proctest$isMalware)
####Writing outputs in a file 
write.csv(testbin, file = "C:/Users/ULTRON/Music/Rmachine/binarypredictions.csv")
###################Prediction on emailsample Bagging trees

test_bagpredict <- predict(ames_bag1, newdata =proctest )
test_bagpredict
confusionMatrix(test_bagpredict, proctest$isMalware)
write.csv(test_bagpredict, file = "C:/Users/ULTRON/Music/Rmachine/baggingtreepredictions.csv")
###########################
#####Elastic Logistic 
test_elasticpredict <- predict(hit_elnet_int, newdata =proctest )
test_elasticpredict
confusionMatrix(test_elasticpredict, proctest$isMalware)
write.csv(test_bagpredict, file = "C:/Users/ULTRON/Music/Rmachine/elasticlogpredictions.csv")
